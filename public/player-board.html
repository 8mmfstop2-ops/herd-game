<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Player Board ‚Äî Udderly the Same</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family:'Segoe UI',Arial,sans-serif;
      max-width:900px;
      margin:30px auto;
      background:linear-gradient(135deg,#fdfcfb,#e2d1c3);
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    .header { display:flex; align-items:center; gap:12px; margin-bottom:20px;}
    .logo { max-width:100px; height:auto; display:block;}
    h2 { margin:0;}
    #statusMessage { font-weight:bold; margin-top:10px; text-align:center; color:#444;}
    button {
      padding:10px 18px; margin:6px; font-size:16px; border:none; border-radius:8px;
      cursor:pointer; background:#333; color:#fff; transition:background 0.3s ease;
    }
    button:hover:enabled { background:#F7AC4D;}
    button:disabled { background:#999; cursor:not-allowed;}
    .accordion { margin-top:20px; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    .accordion-header { background:#333; color:#fff; padding:12px; cursor:pointer; font-weight:bold;}
    .accordion-header:hover { background:#F7AC4D;}
    .accordion-content { max-height:0; overflow:hidden; transition:max-height 0.4s ease; background:#fff; padding:0 15px;}
    .accordion-content.open { padding:15px; max-height:1000px;}
    #answersTable, #playersTable {
      font-size:18px; border-collapse:collapse; width:100%; margin-top:10px;
    }
    #answersTable th,#answersTable td, #playersTable th,#playersTable td {
      border-bottom:1px solid #ccc; padding:8px; text-align:left;
    }
    textarea {
      width:100%; max-width:800px; padding:10px; border-radius:6px;
      border:1px solid #ccc; margin-bottom:10px; font-size:16px;
    }
    /* Toggle switch style */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
      margin-right: 8px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 28px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #4CAF50; }
    input:checked + .slider:before { transform: translateX(22px); }
  </style>
</head>
<body>
  <!-- Header with logo and title -->
  <div class="header">
    <img src="udder-consensus-logo.png" alt="Udderly the Same Logo" class="logo">
    <h2>üêÆ Player Board - DO NOT Refresh Your Browser</h2>
  </div>

  <!-- Accordion for Game Room Info -->
  <div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion('questionBox')">Game Room Info:</div>
    <div id="questionBox" class="accordion-content open">
      <p id="roomLabel"></p>

      <!-- Players table with ghost column -->
      <table id="playersTable">
        <thead><tr><th></th><th>Player</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>

      <div id="controls">
        <button id="startBtn">Start Round</button>
        <button id="showAnswersBtn" disabled>Show Answers</button>
        <p id="statusMessage"></p>
      </div>

      <!-- Override toggle -->
      <div>
        <label class="switch">
          <input type="checkbox" id="overrideSwitch">
          <span class="slider"></span>
        </label>
        <span>Override: allow answer submission</span>
      </div>

      <!-- Question + Answer input (hidden until round starts) -->
      <div id="qaSection" style="display:none;">
        <p id="questionPrompt"></p>
        <textarea id="answerInput" rows="2" placeholder="Type your answer..."></textarea>
        <button id="submitAnswerBtn">Submit Answer</button>
        <p id="progress"></p>
      </div>
    </div>
  </div>

  <!-- Accordion for Answers (hidden by default) -->
  <div id="answersAccordion" class="accordion" style="display:none;">
    <div class="accordion-header" onclick="toggleAccordion('answersTableWrapper')">Answers</div>
    <div id="answersTableWrapper" class="accordion-content">
      <table id="answersTable">
        <thead><tr><th>Name</th><th>Answer</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const urlParams=new URLSearchParams(window.location.search);
    const roomCode=(urlParams.get("room")||"").toUpperCase();
    const myName=urlParams.get("name")||"";
    document.getElementById("roomLabel").innerText=`Room: ${roomCode} ‚Äî You: ${myName}`;
    const socket=io();
    socket.emit("joinLobby",{roomCode,name:myName});

    const startBtn=document.getElementById("startBtn");
    const showBtn=document.getElementById("showAnswersBtn");
    const statusMsg=document.getElementById("statusMessage");
    const overrideSwitch=document.getElementById("overrideSwitch");
    const submitBtn=document.getElementById("submitAnswerBtn");
    const answerInput=document.getElementById("answerInput");

    let currentQuestionId=null;

    // Render full player list with ghost icons
    socket.on("playerList", players => {
      document.querySelector("#playersTable tbody").innerHTML = players
        .map(p => {
          const ghost = p.active ? "" : "üëª";
          const submitted = p.active ? (p.submitted ? "‚úÖ Submitted" : "‚åõ Waiting") : "";
          return `<tr><td>${ghost}</td><td>${escapeHTML(p.name)}</td><td>${submitted}</td></tr>`;
        })
        .join("");
    });

    startBtn.onclick=()=>{socket.emit("startRound",{roomCode});};

    socket.on("roundStarted",({questionId,prompt,playerCount,roundNumber,myAnswer})=>{
      currentQuestionId=questionId;
      startBtn.disabled=true;
      showBtn.disabled=true;
      statusMsg.innerText="Round in progress‚Ä¶";
      document.getElementById("qaSection").style.display="block";
      openAccordion("questionBox");
      closeAccordion("answersTableWrapper");
      document.getElementById("answersAccordion").style.display="none";
      document.getElementById("questionPrompt").innerText=`Round ${roundNumber}: ${prompt}`;
      document.getElementById("progress").innerText=`Submitted: 0 / ${playerCount}`;

      updateSubmitState(myAnswer);

      submitBtn.onclick=()=>{
        const answer=answerInput.value.trim();
        if(!answer) return;
        socket.emit("submitAnswer",{roomCode,name:myName,questionId,answer});
        if(!overrideSwitch.checked){
          submitBtn.disabled=true;
          answerInput.disabled=true;
        }
      };
    });

    socket.on("submissionProgress",({submittedCount,totalPlayers})=>{
      document.getElementById("progress").innerText=`Submitted: ${submittedCount} / ${totalPlayers}`;
    });

    socket.on("allSubmitted",()=>{showBtn.disabled=false;});
    showBtn.onclick=()=>{socket.emit("showAnswers",{roomCode});};

    socket.on("answersRevealed",rows=>{
      document.querySelector("#answersTable tbody").innerHTML=rows
        .map(r=>`<tr><td>${escapeHTML(r.name)}</td><td>${escapeHTML(r.answer)}</td></tr>`).join("");
      document.getElementById("answersAccordion").style.display="block";
      openAccordion("answersTableWrapper");
      closeAccordion("questionBox
