<!-- public/lobby.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Herd Mentality Game — Lobby</title>
  <link rel="stylesheet" href="style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h2>Lobby</h2>
  <p id="roomLabel"></p>
  <ul id="players"></ul>

  <div id="controls">
    <button id="startBtn">Start Round</button>
    <button id="showAnswersBtn" disabled>Show Answers</button>
    <button id="nextRoundBtn" disabled>Next Round</button>
  </div>

  <div id="questionBox" style="display:none;">
    <h3>Question</h3>
    <p id="questionPrompt"></p>
    <textarea id="answerInput" rows="4" cols="50" placeholder="Type your answer..."></textarea>
    <button id="submitAnswerBtn">Submit Answer</button>
    <p id="progress"></p>
  </div>

  <div id="answersTableWrapper" style="display:none;">
    <h3>Answers</h3>
    <table id="answersTable" style="font-size:22px; border-collapse: collapse; width: 100%;">
      <thead>
        <tr>
          <th style="text-align:left; border-bottom:1px solid #ccc;">Name</th>
          <th style="text-align:left; border-bottom:1px solid #ccc;">Answer</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get("room");
    const myName = urlParams.get("name");

    document.getElementById("roomLabel").innerText = `Room: ${roomCode} — You: ${myName}`;

    const socket = io();
    socket.emit("joinLobby", { roomCode, name: myName });

    socket.on("playerList", (names) => {
      document.getElementById("players").innerHTML = names.map(n => `<li>${n}</li>`).join("");
    });

    document.getElementById("startBtn").onclick = () => {
      socket.emit("startRound", { roomCode });
    };

    socket.on("roundStarted", ({ questionId, prompt, playerCount, roundNumber }) => {
      document.getElementById("questionBox").style.display = "block";
      document.getElementById("answersTableWrapper").style.display = "none";
      document.getElementById("showAnswersBtn").disabled = true;
      document.getElementById("nextRoundBtn").disabled = true;

      document.getElementById("questionPrompt").innerText = `Round ${roundNumber}: ${prompt}`;
      document.getElementById("progress").innerText = `Submitted: 0 / ${playerCount}`;
      document.getElementById("submitAnswerBtn").disabled = false;
      document.getElementById("answerInput").disabled = false;
      document.getElementById("answerInput").value = "";

      document.getElementById("submitAnswerBtn").onclick = () => {
        const answer = document.getElementById("answerInput").value.trim();
        if (!answer) return;
        socket.emit("submitAnswer", { roomCode, name: myName, questionId, answer });
        document.getElementById("submitAnswerBtn").disabled = true;
        document.getElementById("answerInput").disabled = true;
      };
    });

    socket.on("submissionProgress", ({ submittedCount, totalPlayers }) => {
      document.getElementById("progress").innerText = `Submitted: ${submittedCount} / ${totalPlayers}`;
    });

    socket.on("allSubmitted", () => {
      document.getElementById("showAnswersBtn").disabled = false;
    });

    document.getElementById("showAnswersBtn").onclick = () => {
      socket.emit("showAnswers", { roomCode });
    };

    socket.on("answersRevealed", (rows) => {
      const tbody = document.querySelector("#answersTable tbody");
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHTML(r.name)}</td>
          <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHTML(r.answer)}</td>
        </tr>
      `).join("");
      document.getElementById("answersTableWrapper").style.display = "block";
      document.getElementById("nextRoundBtn").disabled = false;
    });

    document.getElementById("nextRoundBtn").onclick = () => {
      document.getElementById("answersTableWrapper").style.display = "none";
      socket.emit("nextRound", { roomCode });
      // nextRound triggers readyForNextRound; then startBtn can be used again
    };

    socket.on("readyForNextRound", () => {
      // Optional UX feedback; here we simply enable Start again
      document.getElementById("startBtn").disabled = false;
    });

    socket.on("errorMsg", (msg) => {
      alert(msg);
    });

    function escapeHTML(str) {
      const div = document.createElement('div');
      div.innerText = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
